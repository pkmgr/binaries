#!/usr/bin/env bash

APPNAME="update-motd"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"
PATH="/usr/games:$PATH"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version     : 010920210727-git
# @Author      : Jason
# @Contact     : jason@casjaysdev.com
# @File        : update-motd
# @Created     : Mon, Dec 31, 2019, 00:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : Update the MOTD and ISSUE files
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Set functions

SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
else
  mkdir -p "/tmp/CasjaysDev/functions"
  curl -LSs "$SCRIPTSFUNCTURL/$SCRIPTSFUNCTFILE" -o "/tmp/CasjaysDev/functions/$SCRIPTSFUNCTFILE" || exit 1
  . "/tmp/CasjaysDev/functions/$SCRIPTSFUNCTFILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__help() { printf_help "Usage: update-motd"; }
[ "$1" = "--version" ] && get_app_info "$APPNAME"
[ "$1" = "--help" ] && __help

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
__requiresudo true
__requiresudo rm -Rf /etc/issue* /etc/motd*
dategit="$(date +"%m%d%Y%H%M-git")"
datever="$(date +"%b %d, %Y at %H:%M")"
if [ -f /etc/casjaysdev/updates/versions/scripts.txt ]; then
  scriptsversion="$(__devnull2 cat /etc/casjaysdev/updates/versions/scripts.txt)"
else scriptsversion="$dategit"; fi
if [ -f /etc/casjaysdev/updates/versions/configs.txt ]; then
  configsversion="$(__devnull2 cat /etc/casjaysdev/updates/versions/configs.txt)"
else configsversion="$dategit"; fi
if [ -f /etc/casjaysdev/updates/versions/date.scripts.txt ]; then
  scriptsdate="$(__devnull2 cat /etc/casjaysdev/updates/versions/date.scripts.txt)"
else scriptsdate="$datever"; fi
if [ -f /etc/casjaysdev/updates/versions/date.configs.txt ]; then
  configsdate="$(__devnull2 cat /etc/casjaysdev/updates/versions/date.configs.txt)"
else configsdate="$datever"; fi
distro_version="$distro_version"

messages_issue() {
  if [ -f "$SCRIPTSFUNCTDIR/templates/casjaysdev-legal.txt" ] && [ ! -f /etc/casjaysdev/messages/issue/legal.txt ]; then
    __cp_rf "$SCRIPTSFUNCTDIR/templates/casjaysdev-legal.txt" "/etc/casjaysdev/messages/issue/legal.txt"
  fi
  local messages=$(__devnull2 ls /etc/casjaysdev/messages/issue/*.txt | wc -l)
  if [ "$messages" != "0" ]; then
    cat /etc/casjaysdev/messages/issue/* | sed '/^$/d' | sed '1i\ ' | __devnull __requiresudo tee -a /etc/issue
    printf "\n" | __devnull __requiresudo tee -a /etc/issue
  fi
}

messages_motd() {
  local messages=$(__devnull2 ls /etc/casjaysdev/messages/motd/*.txt | wc -l)
  if [ "$messages" != "0" ]; then
    cat /etc/casjaysdev/messages/motd/* | sed '/^$/d' | __devnull __requiresudo tee -a /etc/motd
  fi
}

motd_fortune() {
  if [ "$(__devnull2 command -v fortune)" ] && [ -n "$(__devnull2 command -v cowsay)" ]; then
    printf "\n" | __devnull __requiresudo tee -a /etc/motd
    fortune | cowsay | __devnull __requiresudo tee -a /etc/motd
    printf "\n" | __devnull __requiresudo tee -a /etc/motd
  else
    printf "\n" | __devnull __requiresudo tee -a /etc/motd
  fi
}

conf_versions() {
  if __if_os_id debian; then
    printf "Debian version: $distro_version\n" | __devnull __requiresudo tee -a /etc/motd
    printf "Config version: $configsversion\n" | __devnull __requiresudo tee -a /etc/motd
  fi

  if __if_os_id rhel; then
    printf "RHEL version: $distro_version\n" | __devnull __requiresudo tee -a /etc/motd
    printf "Config version: $configsversion\n" | __devnull __requiresudo tee -a /etc/motd
  fi

  if __if_os_id arch; then
    printf "Arch version: $distro_version\n" | __devnull __requiresudo tee -a /etc/motd
    printf "Config version: $configsversion\n" | __devnull __requiresudo tee -a /etc/motd
  fi
  if __if_os_id mac; then
    printf "Mac version: $distro_version\n" | __devnull __requiresudo tee -a /etc/motd
    printf "Config version: $configsversion\n" | __devnull __requiresudo tee -a /etc/motd
  fi
  printf "Scripts version $scriptsversion\n" | __devnull __requiresudo tee -a /etc/motd
  printf "configs were last updated on: $configsdate\n" | __devnull __requiresudo tee -a /etc/motd
  printf "scripts package was last updated on: $scriptsdate\n" | __devnull __requiresudo tee -a /etc/motd
  printf "Messages were last updated on: $(date +"%b %d, %Y at %H:%M")\n\n" | __devnull __requiresudo tee -a /etc/motd
}

finalize() {
  __requiresudo touch /etc/issue /etc/motd
  __requiresudo update-ip
  cat /etc/motd | __devnull __requiresudo tee -a /etc/motd.net
  cat /etc/issue | __devnull __requiresudo tee -a /etc/issue.net
  if [ "$1" = "--console" ]; then
    shift 1
    cat /etc/issue /etc/motd
  fi
  if [ "$1" = "--vdebug" ]; then
    shift 1
    cat /etc/issue /etc/motd
    printf_green "dategit: $dategit"
    printf_green "datever: $datever"
    printf_green "scriptsversion: $scriptsversion"
    printf_green "configsversion: $configsversion"
    printf_green "scriptsdate: $scriptsdate"
    printf_green "configsdate: $configsdate"
  fi
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# main function
main() {
  motd_fortune
  messages_motd
  messages_issue
  conf_versions
  finalize "$@"
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# run app
main "$@"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

exit $?
