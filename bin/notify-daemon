#!/usr/bin/env bash

APPNAME="$(basename $0)"
USER="${SUDO_USER:-${USER}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version       : 020220211240-git
# @Author        : Jason Hempstead
# @Contact       : jason@casjaysdev.com
# @License       : WTFPL
# @ReadME        : notify-daemon --help
# @Copyright     : Copyright: (c) 2021 Jason Hempstead, CasjaysDev
# @Created       : Tuesday, Feb 02, 2021 12:40 EST
# @File          : notify-daemon
# @Description   : Start the notification daemon
# @TODO          :
# @Other         :
# @Resource      :
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Set functions
CASJAYSDEVDIR="${CASJAYSDEVDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
user_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
NOTIFYD_HOST="${NOTIFYD_HOST}"
NOTIFYD_PORT="${NOTIFYD_PORT:-65001}"
KILL_PATH="${TMPDIR:-/tmp}/notify-daemon.kill"
SERVER_PATH="${TMPDIR:-/tmp}/notify-daemon/server"
LOG_FILE="$SERVER_PATH.log"

[ -f "$HOME/.config/notify-daemon/settings" ] && . "$HOME/.config/notify-daemon/settings"

__config() {
  printf_green "Generating the config file"
  if [ ! -f "$HOME/.config/notify-daemon/settings" ]; then
    __rm_rf "$HOME/.config/notify-daemon/settings"
    __mkd "$HOME/.config/notify-daemon"
    cat <<EOF >"$HOME/.config/notify-daemon/settings"
NOTIFYD_PORT="${NOTIFYD_PORT:-65001}"
 NOTIFYD_HOST="${NOTIFYD_HOST}"

#Uncomment and insert this into $HOME/.config/notify-daemon/notifyd
#if __cmd_exists pathToDaemon; then
#  notifyd="pathToDaemon"
#  proc="processName"
#  return 0
#else
#  return 1
#fi

EOF
  fi
  [ -f "$HOME/.config/notify-daemon/settings" ] && printf_green "config saved to $HOME/.config/notify-daemon/settings" ||
    printf_error "Failed to save the configuration"
}

netcat="$(command -v nc 2>/dev/null || command -v netcat 2>/dev/null || exit 1)"
__netcat_test() { __cmd_exists $netcat || notifications "Daemon" "The program netcat is not installed"; }
__nc_send() { $netcat -c $1 $2 2>>"$_LOG" && true || $netcat -w 1 $1 $2 2>>"$_LOG" || return 1; }

__kill_server() {
  __netcat_kill "$NOTIFYD_PORT" >/dev/null 2>&1 &&
    printf_blue "Server has been stopped" || printf_red "Failed to stop"
  sleep 2
}
__running() {
  notifications "Daemon" "${proc} is currently the notify daemon"
  pidof "${proc}" >/dev/null 2>&1
}
__getstatus() { pidof "${proc}" >/dev/null 2>&1 && return 0 || return 1; }

__kill() {
  notifications "Daemon" "Stopping the daemon"
  pid="$(pidof "${proc}")"
  kill -9 "${proc}" &>/dev/null
  pid="$(pidof "${proc}" &>/dev/null)" || return 0
}
__start() {
  sleep 1 && "$@" &>/dev/null 2>&1 || return 1 &
  [ $? = 0 ] && notifications "Daemon" "${proc} has been started as the notify daemon" || return 1
}

__restart() {
  __kill "${proc}"
  __start "$1"
}

__client() {
  local _SERVER="$NOTIFYD_HOST"
  local _TMP="${TMPDIR:-/tmp}"
  local _PORT="65001"
  local _PATH="$(mktemp $TMP/notify-clientXXX.tmp)"
  local _LOG="$_PATH.log"
  __netcat_test
  printf_green "Attempting to send message to $_SERVER on $_PORT"
  printf "%s\n" "$*" >"${_PATH}" 2>>"$_LOG"
  cat "$_PATH" 2>>"$_LOG" | __nc_send "$_SERVER" "$_PORT" 2>>"$_LOG"
  [ $? = 0 ] && rm -Rf "$_PATH" || return 1
  return "$?"
}

__server() {
  echo ""
  __clean_return() { __rm_rf "$_PATH" "$_LOG" && return "$1"; }
  local _TMP="${TMPDIR:-/tmp}"
  local _PORT="$NOTIFYD_PORT"
  local _PATH="$SERVER_PATH"
  local _LOG="$LOG_FILE"
  local _KILL="$KILL_PATH"
  __mkd "$TMP/notify-daemon"
  __netcat_test
  netstatg "$_PORT" &>/dev/null && printf_exit "Already Running" || printf_green "Launching server on port $_PORT"
  notifications "Daemon" "Starting notify-daemon server on port $_PORT"
  __rm_rf "$_KILL" "$_LOG"
  while :; do
    cmdsPID="$$"
    echo "$cmdsPID" >>"$_LOG"
    $netcat -l -p "$_PORT" >"$_PATH" 2>>"$_LOG"
    echo "New notification" >>"$_LOG"
    local msg=$(<$_PATH)
    notifications "$msg"
    __clean_return $?
    if [ -f "$_KILL" ]; then
      __kill_server &>/dev/null
      __rm_rf "$_LOG"
      notifications "Daemon" "notify-daemon server is shutting down"
      break
    fi
  done
  __clean_return $?
}

__startup() {
  printf_green "Adding the Notification Daemon to startup"
  cat <<EOF >"$HOME/.config/autostart/notifyd.desktop"
#!/usr/bin/env xdg-open

[Desktop Entry]
Encoding=UTF-8
Version=0.9.4
Type=Application
Name=Notification Daemon
Icon=preferences-desktop-notification
Comment=Start notifyd
Exec=notify-daemon
RunHook=0
StartupNotify=false
Terminal=false
Hidden=false

EOF
  [ -f "$HOME/.config/autostart/notifyd.desktop" ] &&
    printf_green "Successfully installed Notification Daemon" ||
    printf_error "Failed to install Notification Daemon"
  exit $?
}

__server_disable() {
  __rm_rf "$HOME/.config/autostart/notifyd-server.desktop"
  touch "$TMP/notify-daemon.kill"
  __client "Daemon" "Disabling server"
}

__server_enable() {
  printf_green "Enabling the Notification Daemon Server on port $NOTIFYD_PORT"
  cat <<EOF >"$HOME/.config/autostart/notifyd-server.desktop"
#!/usr/bin/env xdg-open

[Desktop Entry]
Version=1.1
Type=Application
Name=Notification Server
GenericName=NotificationServer
Comment=Start Notification Daemon Server.
Icon=preferences-desktop-notification
Exec=notify-daemon --server &
Path=~
Terminal=false
Actions=
Categories=System;GTK;X-XFCE;GNOME;
Keywords=xfce4-notify;notify;music;player;my;
StartupNotify=true
EOF
  notify-daemon --server &
  exit
}

__xfce4_notifyd() {
  if [ -f /usr/lib/xfce4/notifyd/xfce4-notifyd ]; then
    notifyd="/usr/lib/xfce4/notifyd/xfce4-notifyd"
    proc="xfce4-notifyd"
    return 0
  elif [ -f /usr/lib/x86_64-linux-gnu/xfce4/notifyd/xfce4-notifyd ]; then
    notifyd="/usr/lib/x86_64-linux-gnu/xfce4/notifyd/xfce4-notifyd"
    proc="xfce4-notifyd"
    return 0
  else
    return 1
  fi
}

__dunst_notifyd() {
  if __cmd_exists dunst; then
    notifyd="dunst"
    proc="dunst"
    return 0
  else
    return 1
  fi
}

__deadd_notifyd() {
  if __cmd_exists deadd-notification-center; then
    notifyd="deadd-notification-center"
    proc="deadd-notification-center"
    return 0
  else
    return 1
  fi
}

__custom_notifyd() {
  if [ -f "$HOME/.config/notify-daemon/notifyd" ]; then
    source "$HOME/.config/notify-daemon/notifyd"
    [ -n "$proc" ] && [ -n "$notifyd" ] || return 1
  else
    return 1
  fi
}

_start_notifyd() {
  __custom_notifyd || __xfce4_notifyd || __dunst_notifyd || __deadd_notifyd
  _run() { __start "$notifyd" && sleep 5; }
  if [ -z "$proc" ] && [ -z "$notifyd" ]; then
    printf_red "Failed to find a notify daemon"
    printf_exit 1 1 "Please install: xfce4-notifyd, dunst, deadd or custom: see settings file for custom"
  else
    printf_green "Attempting to start"
    while :; do _run && __getstatus "$proc" && break || continue; done
    #notifications "Daemon" "Started"
    printf_green "start $proc has been started" || printf_exit "Failed to start"
  fi
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

case "$1" in
####
*server)
  case $2 in
  *stop | *kill)
    printf_green "Attempting to stop the server"
    shift 2
    touch "$KILL_PATH"
    __kill_server
    #__netcat_pids "$NOTIFYD_PORT"
    exit $?
    ;;
  *restart)
    printf_green "Attempting to restart the server"
    shift 2
    touch "$KILL_PATH"
    __kill_server
    sleep 5
    __server "$@"
    exit $?
    ;;
  *enable)
    shift 2
    __server_enable
    exit $?
    ;;
  *disable)
    shift 2
    __server_disable
    exit $?
    ;;
  *status)
    PID="$(__netcat_pids "$NOTIFYD_PORT")"
    printf_green "The server appears to be running on $NOTIFYD_PORT with PID: $PID"
    notifications "Daemon" "The server appears to be running on $NOTIFYD_PORT with PID: $PID"
    exit
    ;;
  *)
    shift 1
    __server "$@"
    ;;
  esac
  ;;
####

config)
  shift 1
  __config
  ;;

enable)
  shift 1
  __startup
  ;;

disable)
  printf_green "Disabling the notify daemon"
  __rm_rf "$HOME/.config/autostart/notifyd.desktop" &&
    __kill "$proc" &&
    printf_green "Successfully Disabled the notify daemon" ||
    printf_error "Failed to disable notify daemon"
  return $?
  ;;
restart)
  shift 1
  __restart "$notifyd"
  ;;

stop)
  shift 1
  __kill "$proc"
  ;;

status)
  shift 1
  __running "$notifyd"
  ;;

*client)
  if [ -z "$NOTIFYD_HOST" ]; then
    notifications "Daemon" "Please set NOTIFYD_HOST variable to your server"
    exit 1
  fi
  if [ ${#} -eq 0 ]; then
    if [ -p "/dev/stdin" ]; then
      message="$(cat </dev/stdin)"
    fi
  else
    message="$*"
  fi
  __client "$message" 2>/dev/null || notifications "Daemon" "failed to send to $NOTIFYD_HOST"
  ;;

*)
  _start_notifyd
  __getstatus "$proc" || _start_notifyd "$notifyd"
  ;;
esac

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# End
