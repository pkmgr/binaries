#!/usr/bin/env bash

APPNAME="$(basename $0)"
USER="${SUDO_USER:-${USER}}"
HOME="${USER_HOME:-${HOME}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version     : 010920210727-git
# @Author      : Jason
# @Contact     : casjaysdev@casjay.net
# @File        : pkmgr
# @Created     : Wed, Aug 05, 2020, 02:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : Manage system packages
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Set functions

SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$(dirname "${BASH_SOURCE[0]}")"/detectostype ]; then
  source "$(dirname "${BASH_SOURCE[0]}")"/detectostype
elif [ -f /usr/local/bin/detectostype ]; then
  source /usr/local/bin/detectostype
else
  curl -LSs https://github.com/dfmgr/installer/raw/master/bin/detectostype >/tmp/detectostype
  source /tmp/detectostype
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
pkmgr_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__rm_rf() { sudo rm -Rf "$@"; }
__cp_rf() { sudo cp -Rf "$@"; }
__curl() { __devnull2 __am_i_online && curl --disable -LSsfk --connect-timeout 3 --retry 0 --fail "$@" || return 1; }
__curl_sudo() { __devnull2 __am_i_online && curl --disable -LSsfk --connect-timeout 3 --retry 0 --fail "$@" || return 1; }

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Variables - Distro specific
case "$(uname -s)" in                                                                                                             #
Linux)                                                                                                                            #
  if [ -f "$(command -v apt-get)" ]; then                                                                                         #
    export DEBIAN_FRONTEND=noninteractive                                                                                         #
    export APT_OPTS="-o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold""                                   #
    dotfilesrepo="$REPODF/apt"                                                                                                    #
    pkgmgrbin="sudo -E /usr/bin/apt-get"                                                                                          #
    pkgmgrbinins="$pkgmgrbin install"                                                                                             #
    pkgmgrbininssil="$pkgmgrbin install $APT_OPTS --ignore-missing -yy -qq --allow-unauthenticated --assume-yes "                 #
    pkgmgrbinremsil="$pkgmgrbin remove -yy -qq --assume-yes --purge "                                                             #
    pkgmgrbinupdsil="$pkgmgrbin dist-upgrade $APT_OPTS --ignore-missing -yy -qq --allow-unauthenticated --assume-yes "            #
    pkgmgrbinupdcron="$pkgmgrbin dist-upgrade $APT_OPTS --ignore-missing -yy --allow-unauthenticated --assume-yes "               #
    pkgmgrbindel="$pkgmgrbin remove --purge "                                                                                     #
    pkgmgrbinsea="sudo -E /usr/bin/apt-cache search "                                                                             #
    pkgmgrbinupd="$pkgmgrbin dist-upgrade "                                                                                       #
    pkgmgrbincle="$pkgmgrbin clean "                                                                                              #
    pkgmgrbincac="$pkgmgrbin update "                                                                                             #
    pkgmgrexport() { dpkg -l | grep ^ii | awk '{print $2}' | sed "s#:.*##g" | sort -u; }                                          #
  elif [ -f "$(command -v apt)" ]; then                                                                                           #
    export DEBIAN_FRONTEND=noninteractive                                                                                         #
    export APT_OPTS="-o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold""                                   #
    dotfilesrepo="$REPODF/apt"                                                                                                    #
    pkgmgrbin="sudo -E /usr/bin/apt"                                                                                              #
    pkgmgrbinins="$pkgmgrbin install"                                                                                             #
    pkgmgrbininssil="$pkgmgrbin install $APT_OPTS --ignore-missing -yy -qq --allow-unauthenticated --assume-yes "                 #
    pkgmgrbinremsil="$pkgmgrbin remove -yy -qq --assume-yes --purge "                                                             #
    pkgmgrbinupdsil="$pkgmgrbin dist-upgrade $APT_OPTS --ignore-missing -yy -qq --allow-unauthenticated --assume-yes "            #
    pkgmgrbinupdcron="$pkgmgrbin dist-upgrade $APT_OPTS --ignore-missing -yy --allow-unauthenticated --assume-yes "               #
    pkgmgrbindel="$pkgmgrbin remove --purge "                                                                                     #
    pkgmgrbinsea="sudo -E /usr/bin/apt-cache search "                                                                             #
    pkgmgrbinupd="$pkgmgrbin dist-upgrade "                                                                                       #
    pkgmgrbincle="$pkgmgrbin clean "                                                                                              #
    pkgmgrbincac="$pkgmgrbin update "                                                                                             #
    pkgmgrexport() { dpkg -l | grep ^ii | awk '{print $2}' | sed "s#:.*##g" | sort -u; }                                          #
  elif [ -f "$(command -v pacman)" ]; then                                                                                        #
    dotfilesrepo="$REPODF/pacman"                                                                                                 #
    pkgmgrbin="sudo -E /usr/bin/pacman "                                                                                          #
    pkgmgrbinins="$pkgmgrbin -S --noconfirm --overwrite='*' "                                                                     #
    pkgmgrbininssil="$pkgmgrbin -S --noconfirm --needed --overwrite='*' "                                                         #
    pkgmgrbinremsil="$pkgmgrbin -R --noconfirm "                                                                                  #
    pkgmgrbinupdsil="$pkgmgrbin -Syyu --noconfirm "                                                                               #
    pkgmgrbinupdcron="$pkgmgrbin -Syyu --noconfirm "                                                                              #
    pkgmgrbindel="$pkgmgrbin -R "                                                                                                 #
    pkgmgrbinsea="$pkgmgrbin -Ss"                                                                                                 #
    pkgmgrbinupd="$pkgmgrbin -Syyu --needed --overwrite='*'"                                                                      #
    pkgmgrbincle="$pkgmgrbin -Scc "                                                                                               #
    pkgmgrbincac="$pkgmgrbin -Syy "                                                                                               #
    pkgmgrexport() { pacman -Qqe | grep -v "$(pacman -Qqm)" && echo '###' && pacman -Qqet | grep -v "$(pacman -Qqm)" | sort -u; } #
  elif [ -f "$(command -v pamac)" ]; then                                                                                         #
    dotfilesrepo="$REPODF/pacman"                                                                                                 #
    pkgmgrbin="sudo /usr/bin/pamac"                                                                                               #
    pkgmgrbinins="$pkgmgrbin install --noconfirm "                                                                                #
    pkgmgrbininssil="$pkgmgrbin install --noconfirm "                                                                             #
    pkgmgrbinremsil="$pkgmgrbin remove --noconfirm "                                                                              #
    pkgmgrbinupdsil="$pkgmgrbin upgrade -a "                                                                                      #
    pkgmgrbinupdcron="$pkgmgrbin upgrade -a "                                                                                     #
    pkgmgrbindel="$pkgmgrbin remove "                                                                                             #
    pkgmgrbinsea="$pkgmgrbin search -a "                                                                                          #
    pkgmgrbinupd="$pkgmgrbin upgrade -a "                                                                                         #
    pkgmgrbincle="$pkgmgrbin clean "                                                                                              #
    pkgmgrbincac="$pkgmgrbin checkupdates "                                                                                       #
    pkgmgrexport() { pacman -Qqet | grep -v "$(pacman -Qqm)" | sort -u; }                                                         #
  elif [ -f "$(command -v dnf)" ]; then                                                                                           #
    dotfilesrepo="$REPODF/yum"                                                                                                    #
    pkgmgrbin="sudo /usr/bin/dnf"                                                                                                 #
    pkgmgrbinins="$pkgmgrbin install "                                                                                            #
    pkgmgrbininssil="$pkgmgrbin install -y -q "                                                                                   #
    pkgmgrbinremsil="$pkgmgrbin remove -y -q "                                                                                    #
    pkgmgrbinupdsil="$pkgmgrbin update -y -q "                                                                                    #
    pkgmgrbinupdcron="$pkgmgrbin update -y "                                                                                      #
    pkgmgrbindel="$pkgmgrbin remove "                                                                                             #
    pkgmgrbinsea="$pkgmgrbin search "                                                                                             #
    pkgmgrbinupd="$pkgmgrbin updat e"                                                                                             #
    pkgmgrbincle="$pkgmgrbin clean "                                                                                              #
    pkgmgrbincac="$pkgmgrbin makecache "                                                                                          #
    pkgmgrexport() { rpm -qa --qf '%{name}\n' | grep -v gpg-pubkey | sort -u; }                                                   #
  elif [ -f "$(command -v yum)" ]; then                                                                                           #
    dotfilesrepo="$REPODF/yum"                                                                                                    #
    pkgmgrbin="sudo /usr/bin/yum"                                                                                                 #
    pkgmgrbinins="$pkgmgrbin install "                                                                                            #
    pkgmgrbininssil="$pkgmgrbin install -y -q "                                                                                   #
    pkgmgrbinremsil="$pkgmgrbin remove -y -q "                                                                                    #
    pkgmgrbinupdsil="$pkgmgrbin install -y -q "                                                                                   #
    pkgmgrbinupdcron="$pkgmgrbin install -y "                                                                                     #
    pkgmgrbindel="$pkgmgrbin remove "                                                                                             #
    pkgmgrbinsea="$pkgmgrbin search "                                                                                             #
    pkgmgrbinupd="$pkgmgrbin update "                                                                                             #
    pkgmgrbincle="$pkgmgrbin clean "                                                                                              #
    pkgmgrbincac="$pkgmgrbin makecache "                                                                                          #
    pkgmgrexport() { rpm -qa --qf '%{name}\n' | grep -v gpg-pubkey | sort -u; }                                                   #
  elif [ -f "$(command -v xbps-install)" ]; then                                                                                  #
    dotfilesrepo="$REPODF/xbps"                                                                                                   #
    pkgmgrbin="sudo /usr/bin/xbps-install"                                                                                        #
    pkgmgrbinins="$pkgmgrbin -S "                                                                                                 #
    pkgmgrbininssil="$pkgmgrbin -Sy "                                                                                             #
    pkgmgrbinremsil="sudo -H /usr/bin/xbps-remove -y "                                                                            #
    pkgmgrbinupdsil="$pkgmgrbin -Syu "                                                                                            #
    pkgmgrbinupdcron="$pkgmgrbin -Syu "                                                                                           #
    pkgmgrbindel="sudo -H /usr/bin/xbps-remove "                                                                                  #
    pkgmgrbinsea="sudo -H /usr/bin/xbps-query -Rs "                                                                               #
    pkgmgrbinupd="$pkgmgrbin -Syu "                                                                                               #
    pkgmgrbincle="sudo -H /usr/bin/xbps-remove -O "                                                                               #
    pkgmgrbincac="$pkgmgrbin -S "                                                                                                 #
    pkgmgrexport() { xbps-query -l; }                                                                                             #
  fi                                                                                                                              #
  ;;                                                                                                                              #
Darwin)                                                                                                                           #
  if [ -f "$(command -v brew)" ]; then                                                                                            #
    dotfilesrepo="$REPODF/brew"                                                                                                   #
    if [ "$1" = "--cask" ]; then                                                                                                  #
      pkgmgrbin="sudo -u $USER brew --cask"                                                                                       #
    else                                                                                                                          #
      pkgmgrbin="sudo -u $USER brew"                                                                                              #
    fi                                                                                                                            #
    pkgmgrbinins="$pkgmgrbin install"                                                                                             #
    pkgmgrbininssil="$pkgmgrbin install -f "                                                                                      #
    pkgmgrbinremsil="$pkgmgrbin remove -f "                                                                                       #
    pkgmgrbinupdsil="$pkgmgrbin upgrade -f "                                                                                      #
    pkgmgrbinupdcron="$pkgmgrbin upgrade -f "                                                                                     #
    pkgmgrbindel="$pkgmgrbin remove "                                                                                             #
    pkgmgrbinsea="$pkgmgrbin search "                                                                                             #
    pkgmgrbinupd="$pkgmgrbin upgrade "                                                                                            #
    pkgmgrbincle="$pkgmgrbin cleanup "                                                                                            #
    pkgmgrbincac="$pkgmgrbin update "                                                                                             #
    pkgmgrexport() { $pkgmgrbin list --cask && $pkgmgrbin list --formula | sort -u; }                                             #
  fi                                                                                                                              #
  ;;                                                                                                                              #
CYGWIN* | MINGW32* | MSYS* | MINGW*)                                                                                              #
  dotfilesrepo="$REPODF/win"                                                                                                      #
  pkgmgrbin="choco"                                                                                                               #
  pkgmgrbinins="choco install"                                                                                                    #
  pkgmgrbininssil="choco install -yf "                                                                                            #
  pkgmgrbinremsil="choco remove -f "                                                                                              #
  pkgmgrbinupdsil="choco update -yf "                                                                                             #
  pkgmgrbinupdcron="choco update -yf "                                                                                            #
  pkgmgrbindel="choco remove "                                                                                                    #
  pkgmgrbinsea="choco search "                                                                                                    #
  pkgmgrbinupd="choco update "                                                                                                    #
  pkgmgrbincle="choco cleanup"                                                                                                    #
  pkgmgrexport() { echo not enabled; }                                                                                            #
  ;;                                                                                                                              #
*)                                                                                                                                #
  printf_exit "Unknown OS or OS not supported"                                                                                    #
  ;;                                                                                                                              #
esac                                                                                                                              #

if [ -f "$(command -v yay)" ]; then                                                     #
  case "$1" in                                                                          #
  --enable-aur)                                                                         #
    shift 1                                                                             #
    dotfilesrepo="$REPODF/pacman"                                                       #
    pkgmgrbin="sudo -u -HE $USER /usr/bin/yay "                                         #
    pkgmgrbinins="$pkgmgrbin -S --cleanafter --overwrite='*' "                          #
    pkgmgrbininssil="$pkgmgrbin -Sy --needed --noconfirm --cleanafter --overwrite='*' " #
    pkgmgrbinremsil="$pkgmgrbin -Ry --noconfirm --needed --noconfirm"                   #
    pkgmgrbinupdsil="$pkgmgrbin -Syyu --noconfirm "                                     #
    pkgmgrbinupdcron="$pkgmgrbin -Syyu --noconfirm "                                    #
    pkgmgrbindel="$pkgmgrbin -R "                                                       #
    pkgmgrbinsea="$pkgmgrbin -Ss "                                                      #
    pkgmgrbinupd="$pkgmgrbin -Syyu --needed --overwrite='*'"                            #
    pkgmgrbincle="$pkgmgrbin -Scc "                                                     #
    pkgmgrbincac="$pkgmgrbin -Syy "                                                     #
    pkgmgrexport() { pacman -Qqet | grep -v "$(pacman -Qqm)" | sort -u; }               #
    ;;                                                                                  #
  esac                                                                                  #
fi                                                                                      #

pip_run() {
  if __cmd_exists pip3; then
    __devnull2 bash -c "sudo pip3 install --upgrade $*" | printf_readline
  elif cmd_exists pip; then
    __devnull2 bash -c "sudo pip install --upgrade $*" | printf_readline
  else
    exit 1
  fi
}

pip_remove() {
  if __cmd_exists pip3; then
    __devnull2 bash -c "sudo pip3 remove $*" | printf_readline
  elif cmd_exists pip; then
    __devnull2 bash -c "sudo pip remove $*" | printf_readline
  else
    exit 1
  fi
}

#---------------------------------------------------------------------------------------

gem_run() {
  __devnull2 bash -c "sudo gem install --no-user-install $*" | printf_readline
}

gem_remove() {
  __devnull2 bash -c "sudo gem uninstall --no-user-install --force -aIx $*" | printf_readline
}

#---------------------------------------------------------------------------------------

npm_run() {
  NODEINSTDIR="$(command -v node | sed 's#/node##g')"
  __devnull2 bash -c "sudo npm install -g $*" | printf_readline
}

npm_remove() {
  __devnull2 bash -c "sudo npm remove -g $*" | printf_readline
}

#---------------------------------------------------------------------------------------

cpan_run() {
  if c__md_exists cpan; then
    local cpandir="$(devnull2 sudo find /usr/share/perl* /usr/local/share/perl* -path '*/CPAN/Version.pm' | sed 's#/Version.pm##g' | head -n1)"
    local cpanconf="https://raw.githubusercontent.com/casjay-base/centos/master/usr/share/perl5/CPAN/Config.pm"
    local cpanfile="$cpandir/Config.pm"
    if [ ! -f "$cpanfile" ] || [ ! -f "$cpandir/.init" ]; then
      printf_green "Grabbing the CPAN.pm file"
      __urlcheck "$cpanconf" &&
        __curl_sudo "$cpanconf" -o "$cpanfile" &&
        sudo touch "$cpandir/.init" || exit 1
    fi
    bash -c "sudo cpan notest install $*" | printf_readline
  fi
}

cpan_remove() {
  bash -c "sudo cpan --uninstall $*" | printf_readline
}

#---------------------------------------------------------------------------------------

curl_run() {
  [ -z $1 ] && printf_red "Usage: pkmgr curl OS filename or pkmgr curl fullurltolist " && exit
  local os="$(echo $OS | tr '[:upper:]' '[:lower:]')"
  local distro="$(echo $DISTRO | tr '[:upper:]' '[:lower:]')"
  local distroid="$(echo $DISTROID | tr '[:upper:]' '[:lower:]')"
  if [[ $1 =~ https?://.* ]] || [[ $1 =~ ftp?://.* ]]; then
    local url="$1"
    __urlverify "$url"
    __curl "$url" -o /tmp/pkmgr-curl.txt
  else
    local url="$REPO/$1/raw/master/lists/$2.list"
    shift "$#"
    __urlverify "$url"
    __curl "$url" -o /tmp/pkmgr-curl.txt
  fi
}

#---------------------------------------------------------------------------------------

script_run_if_is_url() {
  [ -z $1 ] && printf_red "Usage: pkmgr script filename or url " && exit
  if [[ $1 =~ https?://.* ]] || [[ $1 =~ ftp?://.* ]]; then
    __urlverify "$1"
    __curl "$1" -o /tmp/pkmgr-script.sh
  else
    __cp_rf "$1" "/tmp/pkmgr-script.sh"
  fi
  if [ -f /tmp/pkmgr-script.sh ]; then
    chmod 755 /tmp/pkmgr-script.sh
  else
    printf_red "Error file does not exit"
    exit 1
  fi
}

#---------------------------------------------------------------------------------------

script_run() {
  if [ "$1" = "--script" ]; then
    shift 1
    script_run_if_is_url "$1"
    execute "/tmp/pkmgr-script.sh" "executing the script"
  elif [ "$1" = "--line" ]; then
    shift 1
    script_run_if_is_url "$1"
    while read -r line; do execute "$line" "$line"; done <"/tmp/pkmgr-script.sh"
  else
    script_run_if_is_url "$1"
    /tmp/pkmgr-script.sh
  fi
  rm_rf "/tmp/pkmgr-script.sh"
}

#---------------------------------------------------------------------------------------

__schedule() {
  local logfile="/var/log/pkmgr/cron.log"
  local loggerfile="/var/log/pkmgr/cron.err"
  local file="/etc/cron.d/pkmgr_update"
  local tmpfile="/tmp/pkmgr_cron"
  local mailadmin="${NOTIFICATION_MAIL:-root}"
  local sleepcmd="$(expr $RANDOM \% 300)"
  local date="$(date +"%m-%d-%Y %H:%M")"
  local cronjob="0 4 * * * root sleep ${sleepcmd} ; pkmgr cron run"
  sudo mkdir -p /var/log/pkmgr

  case "$1" in
  remove)
    shift 1
    printf_green "Removing pkmgr schedule"
    rm_rf "$file" ||
      printf_error "Failed to remove $file"
    ;;
  add)
    shift 1
    printf_green "Adding pkmgr to run daily at 4am with random sleep of $sleepcmd seconds"
    echo "MAILTO=$mailadmin" >"$tmpfile"
    echo "$cronjob" >"$tmpfile"
    sudo chown -f root:root "$tmpfile"
    sudo chmod -f 600 "$tmpfile"
    sudo mv -f $tmpfile $file ||
      printf_error "Failed to install $tmpfile to $file"
    ;;
  run)
    shift 1
    echo -e "###########\n$date\n###########\n" | sudo tee -a "$logfile" &>/dev/null
    echo -e "###########\n$date\n###########\n" | sudo tee -a "$loggerfile" &>/dev/null
    sudo $pkgmgrbinupdcron 2>>"$loggerfile.tmp" | sudo tee -a "$logfile" &>/dev/null
    if [ -s "$loggerfile.tmp" ] && [ -f "$loggerfile.tmp" ] && [[ ! -z $(grep '[^[:space:]]' $loggerfile.tmp) ]]; then
      if cmd_exists mail; then
        MAILMESS="$(echo -e "Errors were reported and they are as follows:\n""$(cat $loggerfile.tmp)\n")"
        echo $MAILMESS | mail -r "$mailadmin" -s "pkmgr failed" "$mailadmin"
      fi
    fi
    [ ! -f "$loggerfile.tmp" ] || sudo cat "$loggerfile.tmp" sudo | tee -a "$loggerfile" && rm_rf "$loggerfile.tmp"
    ;;
  *)
    [ -f "$file" ] && pkmgr cron remove || pkmgr cron add
    ;;
  esac
}

#---------------------------------------------------------------------------------------

dotfiles_run() {
  [ -z $1 ] && printf_red "Usage: pkmgr dotfiles name" && exit
  local url="$dotfilesrepo/$1.list"
  __urlverify "$url" && __curl "$url" >/tmp/pkmgr-curl.txt
}

#---------------------------------------------------------------------------------------

__aliases() {
  echo -e "
  alias apt='sudo $APPNAME '
  alias apt-get='sudo $APPNAME '
  alias dnf='sudo $APPNAME '
  alias yum='sudo $APPNAME '
  alias pacman='sudo $APPNAME '
  alias brew='sudo -u $USER $APPNAME '
  "
}

#---------------------------------------------------------------------------------------

show_info() {
  printf_info "         System info for $(hostname -s)"
  printf_green "Repo:                       $dotfilesrepo"
  printf_green "system package manager:     $pkgmgrbin"
  printf_green "Install cmd:                $pkgmgrbinins"
  printf_green "Install silent cmd:         $pkgmgrbininssil"
  printf_green "Remove cmd:                 $pkgmgrbindel"
  printf_green "Remove silent cmd:          $pkgmgrbinremsil"
  printf_green "Update cmd:                 $pkgmgrbinupd"
  printf_green "Update silent cmd:          $pkgmgrbinupdsil"
  printf_green "Search cmd:                 $pkgmgrbinsea"
  printf_green "Clean cache cmd:            $pkgmgrbincle"
  printf_green "Make cache cmd:             $pkgmgrbincac"
  printf_green "Python:                     $(command -v python3 || command -v python2 || echo Not Installed)"
  printf_green "PIP:                        $(command -v pip3 || command -v pip || echo Not Installed)"
  printf_green "CPAN:                       $(command -v cpan || echo Not Installed)"
  printf_green "Gem:                        $(command -v gem || echo Not Installed)"
  printf_green "NPM:                        $(command -v node || echo Not Installed)"
  if __cmd_exists sw_vers; then
    printf_green "Distribution:               MacOS/Darwin"
    printf_green "Release version             $(sw_vers -productVersion)"
  elif [ -f "/etc/os-release" ]; then
    printf_green "Distribution:               $(__if_os_id && echo $distro_id)"
    printf_green "Codename                    $(__if_os_id && echo $code_name)"
    printf_green "Release version             $(__if_os_id && echo $distro_version)"
  elif __cmd_exists lsb_release; then
    printf_green "Distribution                $(lsb_release -a 2>dev >null | grep -i Distributor | awk '{print $3}')"
    printf_green "Codename                    $(lsb_release -a 2>dev >null | grep -i Codename | awk '{print $2}')"
    printf_green "Release version             $(lsb_release -a 2>dev >null | grep -i Release | awk '{print $2}')"
  fi
  printf_green "Kernel version              $(uname -r)"
}

#---------------------------------------------------------------------------------------

exportpkg() {
  [[ "$(uname -s)" =~ Darwin* ]] && DISTRO=MacOS
  [[ "$(uname -s)" =~ ^MING*|WIN*|MSYS* ]] && DISTRO=Windows
  local pkgdir="$HOME/.local/tmp/${DISTRO:-}"
  local pkglist="$pkgdir/$(hostname -s)"
  mkdir -p "$pkgdir"
  printf_green "Exporting package list to $pkglist"
  pkgmgrexport >"$pkglist"
}

#---------------------------------------------------------------------------------------

if [[ "$(devnull2 python3 -V)" =~ "Python 3" ]]; then
  PYTHONVER="python3"
  PIP="pip3"
  PATH="${PATH}:$(python3 -c 'import site; print(site.USER_BASE)')/bin"
elif [[ "$(devnull2 python2 -V)" =~ "Python 2" ]]; then
  PYTHONVER="python"
  PIP="pip"
  PATH="${PATH}:$(python -c 'import site; print(site.USER_BASE)')/bin"
fi
if cmd_exists pacman; then
  PYTHONVER="python"
  PIP="pip3"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f /tmp/pkmgr-curl.txt ]; then
  rm_rf /tmp/pkmgr-curl.txt
fi

#---------------------------------------------------------------------------------------

case "$1" in

help | --*)
  __help
  ;;

available)
  shift 1
  run_install_available
  ;;

aliases)
  shift 1
  if [ -d "$HOME/.config/bash/local" ] && devnull grep userbashprofilelocal "$HOME/.bashrc"; then
    ALIASFILE="$HOME/.config/bash/local/pkmgr.bash"
  else
    ALIASFILE="$HOME/.bash_profile"
  fi
  [ "$1" = "--help" ] && printf_help "Print to terminal or --save to export to bash_profile"
  if [ "$1" = "--save" ]; then
    printf_green "Saving the aliases to your bash profile"
    if grep -vq "# pkmgr aliases" "$ALIASFILE"; then
      echo "# pkmgr aliases - Do not remove this line" >>"$ALIASFILE"
      __aliases >>"$ALIASFILE"
      printf_custom "5" "$ALIASFILE"
    fi
  else
    __aliases | printf_readline "2"
    printf_custom "3" "add --save to save this to the alias file"
    printf_custom "5" "$ALIASFILE"
  fi
  ;;

cron)
  shift 1
  [ "$1" = "--help" ] && printf_help "Options are add, remove, or run"
  __schedule "$@"
  ;;

ask)
  shift 1
  __check_app "$@" && printf_green "Installed: $*" || printf_exit 1 1 "Install of $* failed"
  echo
  ;;

install | -i)
  shift 1
  [ "$1" = "--help" ] && printf_help "Install a package"
  $pkgmgrbinins "${@}" && exit 0 || exit 1
  set --
  ;;

remove | -r)
  shift 1
  [ "$1" = "--help" ] && printf_help "Remove a package"
  $pkgmgrbindel "${@}" && exit 0 || exit 1
  set --
  ;;

list)
  [ "$1" = "--help" ] && printf_help "Install package via a list: pkmgr list ./listToInstall"
  shift 1
  PCKLIST="$(cat "$@" | grep -Ev '^$|^#' | sort -u | tr '\n' ' ' && echo)"
  declare -a LISTARRAY=$PCKLIST
  for pkg in ${LISTARRAY[*]}; do
    execute "$pkgmgrbininssil $pkg" "Installing $pkg"
  done
  ;;

curl)
  shift 1
  [ "$1" = "--help" ] && printf_help "pkmgr curl arch min or pkmgr curl fullURLtoList"
  curl_run "$@"
  set --
  PCKLIST="$(cat /tmp/pkmgr-curl.txt | grep -Ev '^$|^#' | sort -u | tr '\n' ' ' && echo)"
  declare -a LISTARRAY=$PCKLIST
  for pkg in ${LISTARRAY[*]}; do
    execute "$pkgmgrbininssil $pkg" "Installing $pkg"
  done
  [ -z $VDEBUG ] && rm_rf /tmp/pkmgr-curl.txt
  ;;

dotfiles)
  shift 1
  [ "$1" = "--help" ] && printf_help "pkmgr dotfiles git"
  dotfiles_run "$@"
  PCKLIST="$(cat /tmp/pkmgr-curl.txt | grep -Ev '^$|^#' | sort -u | tr '\n' ' ' && echo)"
  declare -a LISTARRAY=$PCKLIST
  for pkg in ${LISTARRAY[*]}; do
    execute "$pkgmgrbininssil $pkg" "Installing $pkg"
  done
  [ -z $VDEBUG ] && rm_rf /tmp/pkmgr-curl.txt
  ;;

script)
  shift 1
  [ "$1" = "--help" ] && printf_help "pkmgr script ./myScript or fullURLtoScript"
  script_run "$@"
  set --
  ;;

upgrade | update | -u)
  shift 1
  [ "$1" = "--help" ] && printf_help "Update your system"
  if [ -f "$(command -v systemmgr)" ]; then
    systemmgr install installer
  fi
  $pkgmgrbinupd
  ;;

export | -x)
  shift 1
  [ "$1" = "--help" ] && printf_help "Export installed packages to a list"
  exportpkg
  ;;

clean | -c)
  shift 1
  [ "$1" = "--help" ] && printf_help "Clean up package manager files"
  $pkgmgrbincle
  ;;

init | -in)
  shift 1
  [ "$1" = "--help" ] && printf_help "Initialize the system by making the cache and updating"
  init="$pkgmgrbincle ; $pkgmgrbincac ; $pkgmgrbinupdsil"
  execute "$init" "Initializing System"
  ;;

makecache | -ca)
  shift 1
  [ "$1" = "--help" ] && printf_help "Create the cache for the package manager"
  __devnull $pkgmgrbincac || exit 1
  ;;

search | -s)
  shift 1
  [ "$1" = "--help" ] && printf_help "Search for a package"
  declare -a LISTARRAY="$*"
  for pkg in ${LISTARRAY[*]}; do
    $pkgmgrbinsea "$pkg" | grep --color=always -z "$pkg" | printf_readline || printf_error "$pkg not found"
  done
  ;;

required)
  shift 1
  [ "$1" = "--help" ] && printf_help "Install required packages"
  declare -a LISTARRAY="$*"
  for pkg in ${LISTARRAY[*]}; do
    execute "$pkgmgrbininssil $pkg" "Installing $pkg"
  done
  ;;

silent-install)
  shift 1
  [ "$1" = "--help" ] && printf_help "Silently install packages"
  declare -a LISTARRAY="$*"
  for pkg in ${LISTARRAY[*]}; do
    __devnull $pkgmgrbininssil "$pkg" && exit 0 || exit 1
  done
  ;;

silent-remove)
  shift 1
  [ "$1" = "--help" ] && printf_help "Silently remove packages"
  declare -a LISTARRAY="$*"
  for pkg in ${LISTARRAY[*]}; do
    __devnull $pkgmgrbinremsil "*$pkg*" && exit 0 || exit 1
  done
  ;;

silent-upgrade | silent-update)
  shift 1
  [ "$1" = "--help" ] && printf_help "Silently upgrade your system"
  if [ -f "$(command -v dotfiles)" ]; then
    __devnull systemmgr install installer
  fi
  __devnull $pkgmgrbinupdsil && exit 0 || exit 1
  ;;

cpan | perl)
  shift 1
  case $1 in
  install)
    shift 1
    [ "$1" = "--help" ] && printf_help "install perl modules via cpan"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      cpan_run "$pkg"
    done
    ;;

  remove)
    shift 1
    [ "$1" = "--help" ] && printf_help "Remove perl modules via cpan"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      cpan_remove "$pkg"
    done
    ;;

  *)
    [ "$1" = "--help" ] && printf_help "install perl modules via cpan"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      cpan_run "$pkg"
    done
    ;;
  esac
  ;;

pip | python)
  shift 1
  case $1 in
  install)
    shift 1
    [ "$1" = "--help" ] && printf_help "Install python modules via pip"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      pip_run "$pkg"
    done
    ;;
  remove)
    shift 1
    [ "$1" = "--help" ] && printf_help "Remove python modules via pip"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      pip_remove "$pkg"
    done
    ;;
  *)
    [ "$1" = "--help" ] && printf_help "Install python modules via pip"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      pip_run "$pkg"
    done
    ;;
  esac
  ;;

gem | ruby)
  shift 1
  case $1 in
  install)
    shift 1
    [ "$1" = "--help" ] && printf_help "Install ruby modules via rubygems"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      gem_run "$pkg"
    done
    ;;

  remove)
    shift 1
    [ "$1" = "--help" ] && printf_help "Remove ruby modules via rubygems"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      gem_remove "$pkg"
    done
    ;;

  *)
    [ "$1" = "--help" ] && printf_help "Install ruby modules via rubygems"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      gem_run "$pkg"
    done
    ;;
  esac
  ;;

npm | node)
  shift 1
  case $1 in
  install)
    shift 1
    [ "$1" = "--help" ] && printf_help "Install node package via npm"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      npm_run "$pkg"
    done
    ;;

  remove)
    shift 1
    [ "$1" = "--help" ] && printf_help "Remove node package via npm"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      npm_remove "$pkg"
    done
    ;;

  *)
    [ "$1" = "--help" ] && printf_help "Install node package via npm"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      npm_run "$pkg"
    done
    ;;
  esac
  ;;

silent)
  shift 1
  case $1 in
  install)
    shift 1
    [ "$1" = "--help" ] && printf_help "Silently install packages"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      __devnull $pkgmgrbininssil "$pkg" && exit 0 || exit 1
    done
    ;;

  remove)
    shift 1
    [ "$1" = "--help" ] && printf_help "Silently remove packages"
    declare -a LISTARRAY="$*"
    for pkg in ${LISTARRAY[*]}; do
      __devnull $pkgmgrbinremsil "*$pkg*" && exit 0 || exit 1
    done
    ;;

  upgrade | update)
    shift 1
    [ "$1" = "--help" ] && printf_help "Silently upgrade your system"
    if [ -f "$(command -v systemmgr)" ]; then
      __devnull systemmgr install installer
    fi
    __devnull $pkgmgrbinupdsil && exit 0 || exit 1
    ;;

  *)
    [ "$1" = "--help" ] && printf_help "Silently install packages | defaults to a silent update"
    if [ -z "$1" ]; then
      __devnull $pkgmgrbinupdsil && exit 0 || exit 1
    else
      declare -a LISTARRAY="$*"
      for pkg in ${LISTARRAY[*]}; do
        __devnull $pkgmgrbininssil "$pkg" && exit 0 || exit 1
      done
    fi
    ;;
  esac
  ;;

info)
  shift 1
  [ "$1" = "--help" ] && printf_help "Show info about your system"
  show_info
  ;;

version)
  shift 1
  run_install_version "$@"
  exit
  ;;

*)
  shift 0
  __help
  sleep 5
  $pkgmgrbin || exit 1
  ;;

esac

#---------------------------------------------------------------------------------------

# end
