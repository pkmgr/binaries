#!/usr/bin/env bash

APPNAME="$(basename $0)"
USER="${SUDO_USER:-${USER}}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
##@Version     : 010920210727-git
# @Author      : Jason
# @Contact     : casjaysdev@casjay.net
# @File        : notes
# @Created     : Wed, Aug 05, 2020, 02:00 EST
# @License     : WTFPL
# @Copyright   : Copyright (c) CasjaysDev
# @Description : take notes using bash
#
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Set functions

SCRIPTSFUNCTURL="${SCRIPTSAPPFUNCTURL:-https://github.com/dfmgr/installer/raw/master/functions}"
SCRIPTSFUNCTDIR="${SCRIPTSAPPFUNCTDIR:-/usr/local/share/CasjaysDev/scripts}"
SCRIPTSFUNCTFILE="${SCRIPTSAPPFUNCTFILE:-testing.bash}"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ -f "$PWD/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$PWD/functions/$SCRIPTSFUNCTFILE"
elif [ -f "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE" ]; then
  . "$SCRIPTSFUNCTDIR/functions/$SCRIPTSFUNCTFILE"
fi

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
systemmgr_install
__options "$@"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

NOTES_FOLDER="$(date +%Y)"
NOTES_FILE="$(date +%m).txt"
NOTES_TMPDIR="${TMP:-/tmp}"
NOTES_DIRECTORY="${NOTES_DIRECTORY:-"$HOME/.local/share/editors/notes"}"
NOTES_EDITOR="${NOTES_EDITOR:-vim}"
NOTES_SERVER_NAME="${NOTES_SERVER_NAME:-localhost}"
NOTES_SERVER_PORT="${NOTES_SERVER_PORT:-65000}"
NOTES_SERVER_DIRECTORY="${NOTES_DIRECTORY}"
NOTES_LOG_FILE="${NOTES_TMPDIR}/notes_server.log"
NOTES_TMP_FILE="$(mktemp ${NOTES_TMPDIR}/notes.XXXXXX.txt)"
NOTES_PATH="${NOTES_DIRECTORY}/$NOTES_FOLDER/${NOTES_FILE}"
NOTES_SERVER_PATH="${NOTES_SERVER_DIRECTORY}/$NOTES_FOLDER/${NOTES_FILE}"

netcat="$(command -v nc 2>/dev/null || command -v netcat 2>/dev/null)"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
mkdir -p "${NOTES_DIRECTORY}/$NOTES_FOLDER"
touch "${NOTES_DIRECTORY}/$NOTES_FOLDER/${NOTES_FILE}"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

if [ ! -f "$NOTES_DIRECTORY/tmux.conf" ]; then
  cat <<EOF >"$NOTES_DIRECTORY/tmux.conf"
# Very basic tmux config
unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
setw -g monitor-activity off
set -g bell-action none
setw -g clock-mode-colour colour5
setw -g mode-style 'fg=colour1 bg=colour18 bold'
set -g pane-border-style 'fg=colour19 bg=colour0'
set -g pane-active-border-style 'bg=colour0 fg=colour9'
set -g status-position bottom
set -g status-justify left
set -g status-style 'bg=colour18 fg=colour137 dim'
set -g status-left ''
set -g status-right '#[fg=colour233,bg=colour19] %m/%d #[fg=colour233,bg=colour8] %H:%M:%S '
set -g status-right-length 50
set -g status-left-length 20
setw -g window-status-current-style 'fg=colour1 bg=colour19 bold'
setw -g window-status-current-format ' #I#[fg=colour249]:#[fg=colour255]#W#[fg=colour249]#F '
setw -g window-status-style 'fg=colour9 bg=colour18'
setw -g window-status-format ' #I#[fg=colour237]:#[fg=colour250]#W#[fg=colour244]#F '
setw -g window-status-bell-style 'fg=colour255 bg=colour1 bold'
set -g message-style 'fg=colour232 bg=colour16 bold'
EOF
fi

systemd_service() {
  [ -f "$1" ] && __rm_rf "$1"
  cat <<EOF | sudo tee "$1" &>/dev/null
[Unit]
Description=Notes Server
After=network.target

[Service]
Type=simple
PrivateTmp=true
Restart=always
RestartSec=5
KillMode=process

Environment=TERM=linux
Environment=HOME=/var/lib/notes_server
Environment=NOTES_TMPDIR=${TMP:-/tmp/notes_server}
Environment=NOTES_DIRECTORY=${NOTES_SERVER_DIRECTORY}
Environment=NOTES_SERVER_NAME=$(hostname)
Environment=NOTES_SERVER_PORT=65000
Environment=NOTES_NOTES_TMPDIR=$TMP
Environment=NOTES_TMP_FILE=$(mktemp $NOTES_TMPDIR/notes.XXXXXX.txt)
Environment=NOTES_LOG_FILE=$NOTES_TMPDIR/notes_server.log

ExecStartPre=/bin/mkdir -p $NOTES_DIRECTORY
ExecStart=/usr/local/bin/notes server run
ExecStopPost=/usr/bin/rm -Rf $NOTES_TMP_FILE $NOTES_LOG_FILE
ExecStop=/bin/kill -KILL $MAINPID
ExecReload=/bin/kill -HUP $MAINPID
TimeoutSec=20
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__netcat_test() { __cmd_exists $netcat || printf_exit "The program netcat is not installed"; }
__nc_send() { $netcat -c $1 $2 2>>"$NOTES_LOG_FILE" && true || $netcat -w 1 $1 $2 2>>"$NOTES_LOG_FILE"; }
__notes() { eval tmux -f "${NOTES_DIRECTORY}/tmux.conf" new-session -D -A -s notes "vim ${NOTES_PATH}" &>/dev/null; }

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__sync() {
  local _NOTESP="${1:-$NOTES_PATH}"
  local _NOTESA="${2:-$NOTES_DIRECTORY}"
  local _TPATH="${3:-$_PATH}"
  [ -n "$_TPATH" ] && cat "${_NOTESP}" "$_TPATH" >$NOTES_TMPDIR/notes_cli.tmp && mv -f $NOTES_TMPDIR/notes_cli.tmp "${_NOTESP}"
  cat "${_NOTESP}" "${_NOTESA}/all.txt" | sort -u | sed '/^$/d' >$NOTES_TMPDIR/notes_cli.tmp && mv -f $NOTES_TMPDIR/notes_cli.tmp "${_NOTESA}/all.txt"
  [ -f $NOTES_TMPDIR/notes_cli.tmp ] && rm -Rf $NOTES_TMPDIR/notes_cli.tmp
  return 0
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__server() {
  local _PORT=${NOTES_SERVER_PORT}
  local _PATH="$NOTES_TMP_FILE"
  __netcat_test
  netstatg "$_PORT" &>/dev/null && printf_exit "Already Running" || printf_green "Launching server on port $_PORT"
  echo "Starting notes server on port $_PORT" >"$NOTES_LOG_FILE"
  rm -Rf $NOTES_TMPDIR/kill_notes
  while :; do
    $netcat -l -p $_PORT >"$_PATH"
    cat $_PATH >>"${NOTES_PATH}" 2>>"$NOTES_LOG_FILE" || break
    notifications "New note" "$(cat $_PATH)\nPosted to: ${NOTES_PATH}"
    if [ -f $NOTES_TMPDIR/kill_notes ]; then
      rm -Rf $NOTES_TMPDIR/kill_notes
      echo "Notes server is shutting down" >>"$NOTES_LOG_FILE"
      break
    fi
  done
  rm -Rf "$_PATH"
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__run_service() {
  local _PORT="${NOTES_SERVER_PORT}"
  local _PATH="$NOTES_TMP_FILE"
  netstatg "$_PORT" &>/dev/null && echo "Already Running" && exit || echo "Launching server on port $_PORT"
  echo "Starting notes server on port $_PORT" >"$NOTES_LOG_FILE"
  rm -Rf $NOTES_TMPDIR/kill_notes
  while true; do
    rm -Rf "$_PATH"
    $netcat -l -p $_PORT >"$_PATH"
    cat "$_PATH" >>"${NOTES_PATH}" 2>>"$NOTES_LOG_FILE" || break
    echo "New note: $(cat $_PATH)"
    rm -Rf "$_PATH"
  done
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

__client() {
  local _SERVER="${NOTES_SERVER_NAME}"
  local _PORT=${NOTES_SERVER_PORT}
  local _PATH="$NOTES_TMP_FILE"
  __netcat_test
  printf_green "Attempting to send message to $_SERVER on $_PORT"
  printf "%s\n" "$*" >"${_PATH}" 2>>$NOTES_TMPDIR/notes_client
  cat "$_PATH" 2>>$NOTES_TMPDIR/notes_client | __nc_send "$_SERVER" "$_PORT" 2>>$NOTES_TMPDIR/notes_client || printf_red "failed to send massage"
  __sync "$NOTES_PATH" "$NOTES_DIRECTORY" "$_PATH"
  rm -Rf "$_PATH"
  return "$?"
}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

case "$1" in
server)
  shift 1
  if [ "$1" = "--help" ]; then shift 1 && printf_help 'Usage: notes server  |  Start the server'; fi
  if [ "$1" = "--status" ]; then shift 1 && netstatg $_PORT >/dev/null 2>&1; fi
  if [ "$1" = "--kill" ]; then
    shift 1 && touch $NOTES_TMPDIR/kill_notes >/dev/null 2>&1
    printf_exit "Starting shutdown"
  fi

  case "$1" in
  install)
    shift 1
    NOTES_DIRECTORY="$NOTES_SERVER_DIRECTORY"
    systemd_service "/etc/systemd/system/notes_server.service"
    sudo systemctl daemon-reload
    sudo systemctl enable -f notes_server
    ;;
  remove)
    shift 1
    sudo systemctl disable -f notes_server
    sudo systemctl daemon-reload
    __rm_rf /etc/systemd/system/notes_server.service
    ;;
  start)
    shift 1
    sudo systemctl start notes_server
    ;;
  stop)
    shift 1
    sudo systemctl stop notes_server
    ;;
  restart)
    shift 1
    sudo systemctl restart notes_server
    ;;
  status)
    shift 1
    sudo systemctl status notes_server
    ;;
  run)
    shift 1
    opts="$*"
    __run_service "$opts" 2>>"$NOTES_LOG_FILE"
    ;;
  *)
    printf_exit "Server is running" || printf_exit "Server is stopped"
    opts="$*"
    __server "$opts" 2>>"$NOTES_LOG_FILE" &
    ;;
  esac
  ;;

client)
  shift 1
  [ "$1" = "--help" ] && printf_help 'Usage: notes client "my message"  |  Send your notes to the server'
  [ -n "$NOTES_SERVER_NAME" ] || printf_help "Please set NOTES_SERVER_NAME variable to your server"
  if [ ${#} -eq 0 ]; then
    if [ -p "/dev/stdin" ]; then
      message="$(cat </dev/stdin)"
    fi
  else
    message="$*"
  fi
  __client "$message" 2>/dev/null
  ;;

open)
  shift 1
  __notes "$@" 2>/dev/null
  ;;

-)
  shift 1
  printf "%s\n" "$(</dev/stdin)" >>"${NOTES_PATH}"
  ;;

all)
  shift 1
  cat ${NOTES_DIRECTORY}/all.txt
  ;;

*)
  if [ ${#} -eq 0 ]; then
    if [ -p "/dev/stdin" ]; then
      (
        cat -
      ) >>"${NOTES_PATH}"
    else
      __notes
    fi
  else
    printf "%s\n" "${*}" >>"${NOTES_PATH}"
  fi
  __sync $NOTES_PATH $NOTES_DIRECTORY 2>/dev/null

  ;;

esac

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
exit $?
# end
